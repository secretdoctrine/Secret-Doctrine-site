= javascript_include_tag 'refinery/books/jstree'
= javascript_include_tag 'refinery/books/jstree-actions'
= stylesheet_link_tag 'refinery/books/jstree'


- jstree_div = 'jstree_container'
%section#records
  %div{:id => jstree_div}
    %ul
      = render :partial => 'multimedia_group', :locals => {multimedia_group: @root}



:javascript

  function get_jstree() {
    return $("##{jstree_div}").jstree(true);
  }

  $("##{jstree_div}").jstree({
    "plugins" : ["actions", "dnd"],
    "core" : {
      "themes" : {"icons" : false},
      "multiple" : false,
      "check_callback": function(operation, node, node_parent, node_position, more) {
          // operation can be 'create_node', 'rename_node', 'delete_node', 'move_node' or 'copy_node'
          // in case of 'rename_node' node_position is filled with the new node name

          if (operation === "move_node") {
            if(node.li_attr.node_type === 'group')
            {
              if(node_parent.li_attr.node_type !== 'group')
                return false;
            }
            if(node.li_attr.node_type === 'item')
            {
              if(node_parent.li_attr.node_type !== 'group' || node_parent.li_attr.is_root === 'true')
                return false;
            }

          }
          return true;  //allow all other operations
      }
    }
  })
  .on('move_node.jstree', function(e, data) {
    $.ajax({
      url: data.node.li_attr.update_path,
      dataType: "json",
      type: 'PUT',
      success: function(data) {
        return false;
      },
      data: {new_parent: data.parent,
            old_parent: data.old_parent,
            new_position: data.position,
            old_position: data.old_position}
    });
  })
  .on('ready.jstree', function () {
    var ids = $(".jstree-group-add").map(function() { return $(this).attr("id") }).get();
    for(var i = 0; i < ids.length; i++)
    {
      $("##{jstree_div}").jstree(true).add_action(ids[i], {
          "id": "action_group_add",
          "class": "action_add pull-right",
          "text": "+",
          "after": true,
          "selector": "a",
          "event": "click",
          "callback": function(node_id, node, action_id, action_el){
              document.location.href = node.li_attr.new_group_path;
          }
      });
    }

    var ids = $(".jstree-item-add").map(function() { return $(this).attr("id") }).get();
    for(var i = 0; i < ids.length; i++)
    {
      $("##{jstree_div}").jstree(true).add_action(ids[i], {
          "id": "action_item_add",
          "class": "action_add pull-right",
          "text": "I",
          "after": true,
          "selector": "a",
          "event": "click",
          "callback": function(node_id, node, action_id, action_el){
              document.location.href = node.li_attr.new_item_path;
          }
      });
    }

    ids = $(".jstree-edit").map(function() { return $(this).attr("id") }).get();
    for(var i = 0; i < ids.length; i++)
    {
      $("##{jstree_div}").jstree(true).add_action(ids[i], {
          "id": "action_rename",
          "class": "action_rename pull-right",
          "text": "=",
          "after": true,
          "selector": "a",
          "event": "click",
          "callback": function(node_id, node, action_id, action_el){
              document.location.href = node.li_attr.edit_path;
          }
      });
    }

    ids = $(".jstree-destroy").map(function() { return $(this).attr("id") }).get();
    for(var i = 0; i < ids.length; i++)
    {
      $("##{jstree_div}").jstree(true).add_action(ids[i], {
          "id": "action_destroy",
          "class": "action_destroy pull-right",
          "text": "x",
          "after": true,
          "selector": "a",
          "event": "click",
          "callback": function(node_id, node, action_id, action_el){
              if(!confirm("#{::I18n.t('multimedia_groups.delete_confirm')}"))
                return;
              $.ajax({
                url: node.li_attr.destroy_path,
                type: "DELETE"
              }).done(function(){
                window.location.reload();
              }).fail(function(){
                window.location.reload();
              });
          }
      });
    }

  });
